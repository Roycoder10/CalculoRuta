<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wilder Roy Llacchua Iman SAC - App Web</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9;
        }
        .container {
            max-width: 900px;
            margin: 2rem auto;
            background-color: #ffffff;
            padding: 2rem;
            border-radius: 1.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .text-area-container {
            position: relative;
        }
        .text-area-placeholder {
            position: absolute;
            top: 1rem;
            left: 1rem;
            color: #9ca3af;
            pointer-events: none;
            transition: transform 0.2s, opacity 0.2s;
        }
        textarea:focus + .text-area-placeholder,
        textarea:not(:placeholder-shown) + .text-area-placeholder {
            transform: translateY(-1.25rem) scale(0.85);
            opacity: 0;
        }
        #map {
            height: 400px;
            width: 100%;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-top: 1.5rem;
        }
        .chart-container {
            position: relative;
            width: 100%;
            height: 300px;
            margin-top: 2rem;
        }
        /* Estilo para el icono de parada */
        .stop-icon {
            background-color: #e53e3e;
            width: 1.5rem;
            height: 1.5rem;
            display: block;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            text-align: center;
            line-height: 1.5rem;
            color: white;
            font-weight: bold;
        }
    </style>
</head>
<body class="bg-gray-200">

<div class="container">
    <div class="flex flex-col items-center gap-4 mb-6">
        <img src="https://placehold.co/100x100/1e40af/ffffff?text=RyLi+SAC" alt="Logo de RyLi SAC" class="w-16 h-16 rounded-full shadow-lg">
        <h1 class="text-3xl font-bold text-center text-gray-800">Análisis de Rutas de transporte</h1>
        <p class="text-center text-gray-600">Ingresa los datos del GPS a continuación.</p>
    </div>
    
    <div class="text-area-container mb-4">
        <textarea id="dataInput" rows="10" placeholder=" " class="w-full p-4 text-gray-700 bg-gray-50 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all resize-y"></textarea>
        <label for="dataInput" class="text-area-placeholder text-gray-400">
Ejemplo:
31/08/2025 22:10:57 -12.0298916 -77.0427916 RIMAC/LIMA/LIMA 15 km/h
31/08/2025 22:12:05 -12.0299500 -77.0427800 RIMAC/LIMA/LIMA 12 km/h
...
</label>
    </div>

    <!-- Filtro de rango de fecha y hora -->
    <div class="mb-6">
        <h3 class="text-lg font-bold text-gray-700 mb-2">Filtra por rango (opcional)</h3>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div>
                <label for="startDateFilter" class="block text-sm font-medium text-gray-700">Fecha de inicio</label>
                <input type="date" id="startDateFilter" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
            </div>
            <div>
                <label for="endDateFilter" class="block text-sm font-medium text-gray-700">Fecha de fin</label>
                <input type="date" id="endDateFilter" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
            </div>
            <div>
                <label for="startTimeFilter" class="block text-sm font-medium text-gray-700">Hora de inicio</label>
                <input type="time" id="startTimeFilter" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
            </div>
            <div>
                <label for="endTimeFilter" class="block text-sm font-medium text-gray-700">Hora de fin</label>
                <input type="time" id="endTimeFilter" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
            </div>
        </div>
    </div>
    
    <!-- Selección de Vehículo -->
    <div class="mb-6">
        <h3 class="text-lg font-bold text-gray-700 mb-2">Selecciona Tipo de Vehículo</h3>
        <select id="vehicleType" class="w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all">
            <option value="sedan">Automóvil (Sedán)</option>
            <option value="suv">Camioneta (SUV)</option>
            <option value="truck">Remolcador/Camión (Pesado)</option>
            <option value="bus">Ómnibus (Interurbano)</option>
        </select>
    </div>

    <div class="flex flex-col md:flex-row gap-4 mb-8">
        <button onclick="analyzeData()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition-all text-lg">
            Analizar Datos
        </button>
        <div class="grid grid-cols-2 gap-4 w-full">
            <button onclick="exportToCSV()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition-all">
                Exportar CSV
            </button>
            <button onclick="exportToPDF()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition-all">
                Exportar PDF
            </button>
        </div>
    </div>
    
    <div id="results" class="results-container">
        <div id="error" class="mt-4 text-center text-red-500 hidden">
            <p id="error-message">Hubo un error al procesar los datos. Asegúrate de que el formato sea correcto y que hayas ingresado al menos dos puntos para cada día.</p>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<!-- FIX: Se han actualizado las librerías de Chart.js y sus adaptadores a las versiones más recientes y estables -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/date-fns@3.6.0/dist/date-fns.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
<!-- Nuevas librerías para zoom y anotaciones -->
<script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8/hammer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
    let mapInstance = null;
    let speedChartInstance = null;
    let distanceChartInstance = null;

    // Tasas de rendimiento de combustible en km por galón
    const VEHICLE_PERFORMANCE_RATES_KM_PER_GALLON = {
        sedan: 37.85,  // 10 km/litro -> 37.85 km/galón
        suv: 30.28,    // 8 km/litro -> 30.28 km/galón
        truck: 11.35,  // 3 km/litro -> 11.35 km/galón
        bus: 3.33      // 1 km / 0.3 galones = 3.33 km/galón
    };
    const SOLES_PER_GALLON = 9.10;
    const LITERS_PER_GALLON = 3.785;
    const SPEED_LIMIT = 95; // Límite de velocidad en km/h

    // Helper function to format time from minutes to "X horas Y minutos"
    function formatTime(minutes) {
        if (minutes < 0) return "0 horas 0 minutos";
        const hours = Math.floor(minutes / 60);
        const remainingMinutes = Math.round(minutes % 60);
        return `${hours} horas ${remainingMinutes} minutos`;
    }

    // Helper function to format time from minutes to "X minutos Y segundos" for stops
    function formatStopDuration(minutes) {
        if (minutes < 0) return "0 minutos 0 segundos";
        const min = Math.floor(minutes);
        const seconds = Math.round((minutes - min) * 60);
        return `${min} minutos y ${seconds} segundos`;
    }

    function toRadians(degrees) {
        return degrees * Math.PI / 180;
    }

    function haversineDistance(lat1, lon1, lat2, lon2) {
        const R = 6371; // Radio de la Tierra en kilómetros

        const lat1Rad = toRadians(lat1);
        const lat2Rad = toRadians(lat2);
        const deltaLat = toRadians(lat2 - lat1);
        const deltaLon = toRadians(lon2 - lon1);

        const a = Math.sin(deltaLat / 2) * Math.sin(deltaLat / 2) +
                  Math.cos(lat1Rad) * Math.cos(lat2Rad) *
                  Math.sin(deltaLon / 2) * Math.sin(deltaLon / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

        return R * c;
    }
    
    // Función para calcular el consumo de combustible en galones y el costo total
    function calculateFuelAndCost(distance, vehicleType) {
        const kmPerGallon = VEHICLE_PERFORMANCE_RATES_KM_PER_GALLON[vehicleType];
        if (!kmPerGallon || kmPerGallon === 0) return { gallons: 0, cost: 0 };
        
        const gallonsConsumed = distance / kmPerGallon;
        const totalCost = gallonsConsumed * SOLES_PER_GALLON;
        
        return { gallons: gallonsConsumed, cost: totalCost };
    }

    function analyzeData() {
        const input = document.getElementById('dataInput').value;
        const startDateFilter = document.getElementById('startDateFilter').value;
        const endDateFilter = document.getElementById('endDateFilter').value;
        const startTimeFilter = document.getElementById('startTimeFilter').value;
        const endTimeFilter = document.getElementById('endTimeFilter').value;
        const vehicleType = document.getElementById('vehicleType').value;
        const resultsDiv = document.getElementById('results');
        const errorDiv = document.getElementById('error');
        const errorMessage = document.getElementById('error-message');
        
        resultsDiv.innerHTML = `<div id="error" class="mt-4 text-center text-red-500 hidden"><p id="error-message">Hubo un error al procesar los datos. Asegúrate de que el formato sea correcto y que hayas ingresado al menos dos puntos para cada día.</p></div>`;
        errorDiv.classList.add('hidden');

        // VALIDACIÓN DE FECHA Y HORA
        if ((startDateFilter && endDateFilter) || (startTimeFilter && endTimeFilter)) {
            const startDateTime = new Date(`${startDateFilter || '1970-01-01'}T${startTimeFilter || '00:00'}:00`);
            const endDateTime = new Date(`${endDateFilter || '2099-12-31'}T${endTimeFilter || '23:59'}:59`);

            if (startDateTime > endDateTime) {
                errorMessage.innerText = "La fecha y hora de inicio no pueden ser posteriores a la de fin.";
                errorDiv.classList.remove('hidden');
                return;
            }
        }

        let lines = input.trim().split('\n').filter(line => line.trim() !== '');

        if (lines.length === 0) {
            errorMessage.innerText = "Por favor, introduce datos en el campo de texto.";
            errorDiv.classList.remove('hidden');
            return;
        }

        // Validación y filtrado del rango de fecha y hora de forma combinada
        if (startDateFilter || endDateFilter || startTimeFilter || endTimeFilter) {
            const startDateTime = new Date(
                (startDateFilter || '1970-01-01') + 'T' + (startTimeFilter || '00:00') + ':00'
            );
            const endDateTime = new Date(
                (endDateFilter || '2099-12-31') + 'T' + (endTimeFilter || '23:59') + ':59'
            );
            
            lines = lines.filter(line => {
                const parts = line.split(/\s+/);
                const rawDate = parts[0];
                const time = parts[1];
                
                const dateParts = rawDate.split('/');
                const currentDateTime = new Date(`${dateParts[2]}-${dateParts[1]}-${dateParts[0]}T${time}`);

                return currentDateTime >= startDateTime && currentDateTime <= endDateTime;
            });
        }

        if (lines.length < 2) {
            errorMessage.innerText = "No se encontraron suficientes puntos de datos que coincidan con los filtros aplicados. Se requieren al menos dos puntos.";
            errorDiv.classList.remove('hidden');
            return;
        }

        const dataByDate = {};
        let grandTotalDistance = 0;
        let grandTotalOperatingTime = 0;
        let grandTotalStoppedTime = 0;
        let summaryTableContent = '';
        let eventsContent = '';

        const ACCELERATION_THRESHOLD = 20; // km/h por minuto
        const DECELERATION_THRESHOLD = -20; // km/h por minuto
        
        const allLatLngs = [];
        const speedData = [];
        const distanceData = [];
        const stops = [];
        let accumulatedDistance = 0;

        try {
            lines.forEach(line => {
                const parts = line.trim().split(/\s+/);
                
                if (parts.length < 6) {
                    throw new Error("Formato de línea incorrecto");
                }

                const date = parts[0];
                const time = parts[1];
                const lat = parseFloat(parts[2]);
                const lon = parseFloat(parts[3]);
                const speed = parseFloat(parts[parts.length - 2]);

                const locationParts = parts.slice(4, parts.length - 2);
                const location = locationParts.join(' ');
                
                if (isNaN(lat) || isNaN(lon) || isNaN(speed)) {
                    throw new Error("Valores numéricos inválidos");
                }

                const dataPoint = { date, time, lat, lon, location, speed };

                if (!dataByDate[date]) {
                    dataByDate[date] = [];
                }
                dataByDate[date].push(dataPoint);
                
                allLatLngs.push([lat, lon]);

                const dateParts = date.split('/');
                const timeParts = time.split(':');
                const timestamp = new Date(dateParts[2], dateParts[1] - 1, dateParts[0], timeParts[0], timeParts[1], timeParts[2]).getTime();
                
                speedData.push({ 
                    x: timestamp, 
                    y: speed, 
                    location: location, 
                    date: date, 
                    time: time 
                });
            });

            for (const date in dataByDate) {
                const dailyData = dataByDate[date];
                if (dailyData.length < 2) continue;

                dailyData.sort((a, b) => {
                    const dateA = new Date(a.date.split('/')[2], a.date.split('/')[1] - 1, a.date.split('/')[0], a.time.split(':')[0], a.time.split(':')[1], a.time.split(':')[2]);
                    const dateB = new Date(b.date.split('/')[2], b.date.split('/')[1] - 1, b.date.split('/')[0], b.time.split(':')[0], b.time.split(':')[1], b.time.split(':')[2]);
                    return dateA - dateB;
                });

                let totalDistance = 0;
                let totalStoppedTime = 0;
                let totalMovingTime = 0;
                let excessiveSpeedCount = 0;
                let harshAccelerationCount = 0;
                let harshBrakingCount = 0;
                
                let isStopped = false;
                let stopStartTime = null;
                let stopStartLocation = null;
                let stopStartLatLng = null;

                eventsContent += `
                    <div class="mt-8">
                        <h3 class="text-xl font-bold text-gray-700 mb-2">Eventos detectados el ${date}</h3>
                        <ul class="list-disc pl-6 text-gray-600 mb-4">
                `;

                for (let i = 0; i < dailyData.length - 1; i++) {
                    const current = dailyData[i];
                    const next = dailyData[i + 1];
                    const timeDiff = (new Date(next.date.split('/')[2], next.date.split('/')[1] - 1, next.date.split('/')[0], next.time.split(':')[0], next.time.split(':')[1], next.time.split(':')[2]) - new Date(current.date.split('/')[2], current.date.split('/')[1] - 1, current.date.split('/')[0], current.time.split(':')[0], current.time.split(':')[1], current.time.split(':')[2])) / 1000 / 60; // en minutos

                    // Lógica para determinar el tiempo detenido y registrar paradas
                    if (current.speed === 0) {
                        totalStoppedTime += timeDiff;
                        if (!isStopped) {
                            isStopped = true;
                            stopStartTime = new Date(current.date.split('/')[2], current.date.split('/')[1] - 1, current.date.split('/')[0], current.time.split(':')[0], current.time.split(':')[1], current.time.split(':')[2]);
                            stopStartLocation = current.location;
                            stopStartLatLng = [current.lat, current.lon];
                        }
                    } else {
                        const segmentDistance = haversineDistance(current.lat, current.lon, next.lat, next.lon);
                        totalDistance += segmentDistance;
                        accumulatedDistance += segmentDistance;
                        totalMovingTime += timeDiff;

                        if (isStopped) {
                            isStopped = false;
                            const stopEndTime = new Date(current.date.split('/')[2], current.date.split('/')[1] - 1, current.date.split('/')[0], current.time.split(':')[0], current.time.split(':')[1], current.time.split(':')[2]);
                            const durationMinutes = (stopEndTime - stopStartTime) / 1000 / 60;
                            stops.push({ lat: stopStartLatLng[0], lon: stopStartLatLng[1], date: current.date, time: current.time, duration: durationMinutes, location: stopStartLocation });
                        }
                    }

                    if (current.speed > SPEED_LIMIT) {
                        excessiveSpeedCount++;
                        eventsContent += `<li class="text-red-500">⚠ <strong>Exceso de velocidad</strong> (${current.speed} km/h) a las ${current.time} en ${current.location}</li>`;
                    }

                    const speedChange = next.speed - current.speed;
                    if (timeDiff > 0) {
                        const speedChangePerMinute = speedChange / timeDiff;
                        if (speedChangePerMinute > ACCELERATION_THRESHOLD) {
                            harshAccelerationCount++;
                            eventsContent += `<li class="text-red-500">⚠ <strong>Aceleración brusca</strong> (cambio de ${speedChange.toFixed(2)} km/h) a las ${current.time}</li>`;
                        } else if (speedChangePerMinute < DECELERATION_THRESHOLD) {
                            harshBrakingCount++;
                            eventsContent += `<li class="text-red-500">⚠ <strong>Frenado brusco</strong> (cambio de ${speedChange.toFixed(2)} km/h) a las ${current.time}</li>`;
                        }
                    }
                    
                    const nextDateParts = next.date.split('/');
                    const nextTimeParts = next.time.split(':');
                    const nextTimestamp = new Date(nextDateParts[2], nextDateParts[1] - 1, nextDateParts[0], nextTimeParts[0], nextTimeParts[1], nextTimeParts[2]).getTime();

                    distanceData.push({ x: nextTimestamp, y: accumulatedDistance, date: next.date, time: next.time });
                }
                
                if (isStopped) {
                    const lastPoint = dailyData[dailyData.length - 1];
                    const stopEndTime = new Date(lastPoint.date.split('/')[2], lastPoint.date.split('/')[1] - 1, lastPoint.date.split('/')[0], lastPoint.time.split(':')[0], lastPoint.time.split(':')[1], lastPoint.time.split(':')[2]);
                    const durationMinutes = (stopEndTime - stopStartTime) / 1000 / 60;
                    stops.push({ lat: stopStartLatLng[0], lon: stopStartLatLng[1], date: lastPoint.date, time: lastPoint.time, duration: durationMinutes, location: stopStartLocation });
                }

                if (excessiveSpeedCount > 0 || harshAccelerationCount > 0 || harshBrakingCount > 0) {
                    eventsContent += `</ul></div>`;
                } else {
                    eventsContent += `<li class="text-green-500">✅ Sin eventos de riesgo detectados.</li></ul></div>`;
                }

                grandTotalDistance += totalDistance;
                grandTotalOperatingTime += totalMovingTime;
                grandTotalStoppedTime += totalStoppedTime;

                const avgSpeed = totalMovingTime > 0 ? (totalDistance / (totalMovingTime / 60)) : 0; // km/h

                summaryTableContent += `
                    <tr class="hover:bg-gray-100 transition-colors">
                        <td class="px-6 py-4 whitespace-nowrap">${date}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-blue-600 font-semibold">${totalDistance.toFixed(2)} km</td>
                        <td class="px-6 py-4 whitespace-nowrap text-blue-600 font-semibold">${avgSpeed.toFixed(2)} km/h</td>
                        <td class="px-6 py-4 whitespace-nowrap text-blue-600 font-semibold">${formatTime(totalStoppedTime)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-red-500 font-semibold">${excessiveSpeedCount}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-red-500 font-semibold">${harshAccelerationCount}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-red-500 font-semibold">${harshBrakingCount}</td>
                    </tr>
                `;
            }

            if (Object.keys(dataByDate).length === 0) {
                errorMessage.innerText = "No se encontraron datos que coincidan con los filtros aplicados. Por favor, revisa tus criterios de búsqueda.";
                errorDiv.classList.remove('hidden');
                return;
            }
            
            // Calculo del consumo de combustible y el costo total
            const { gallons, cost } = calculateFuelAndCost(grandTotalDistance, vehicleType);
            const totalLiters = gallons * LITERS_PER_GALLON;

            const firstPoint = lines[0].trim().split(/\s+/);
            const firstPointDate = firstPoint[0];
            const firstPointTime = firstPoint[1];
            const firstPointLocation = firstPoint.slice(4, firstPoint.length - 2).join(' ');

            const lastPoint = lines[lines.length - 1].trim().split(/\s+/);
            const lastPointDate = lastPoint[0];
            const lastPointTime = lastPoint[1];
            const lastPointLocation = lastPoint.slice(4, lastPoint.length - 2).join(' ');
            
            // Calculo del tiempo total de la ruta
            const grandTotalTripTime = grandTotalOperatingTime + grandTotalStoppedTime;

            resultsDiv.innerHTML = `
                <div id="summary-section">
                    <div class="text-center mb-8 p-6 bg-blue-100 rounded-lg border border-blue-200 shadow-md">
                        <h2 class="text-xl font-extrabold text-blue-800 mb-2">Resumen General</h2>
                        <div class="grid grid-cols-1 md:grid-cols-6 gap-4 text-left">
                            <div class="bg-blue-200 p-4 rounded-lg shadow-inner">
                                <p class="text-xs font-semibold text-blue-900">Recorrido Total</p>
                                <p class="text-xl font-extrabold text-blue-600">${grandTotalDistance.toFixed(2)} km</p>
                            </div>
                            <div class="bg-blue-200 p-4 rounded-lg shadow-inner">
                                <p class="text-xs font-semibold text-blue-900">Tiempo en Operación</p>
                                <p class="text-xl font-extrabold text-blue-600">${formatTime(grandTotalOperatingTime)}</p>
                            </div>
                            <div class="bg-blue-200 p-4 rounded-lg shadow-inner">
                                <p class="text-xs font-semibold text-blue-900">Tiempo Detenido</p>
                                <p class="text-xl font-extrabold text-blue-600">${formatTime(grandTotalStoppedTime)}</p>
                            </div>
                            <div class="bg-blue-200 p-4 rounded-lg shadow-inner">
                                <p class="text-xs font-semibold text-blue-900">Galones Consumidos</p>
                                <p class="text-xl font-extrabold text-blue-600">${gallons.toFixed(2)} gal</p>
                            </div>
                            <div class="bg-blue-200 p-4 rounded-lg shadow-inner">
                                <p class="text-xs font-semibold text-blue-900">Litros Consumidos</p>
                                <p class="text-xl font-extrabold text-blue-600">${totalLiters.toFixed(2)} l</p>
                            </div>
                            <div class="bg-blue-200 p-4 rounded-lg shadow-inner">
                                <p class="text-xs font-semibold text-blue-900">Costo Total</p>
                                <p class="text-xl font-extrabold text-blue-600">S/. ${cost.toFixed(2)}</p>
                            </div>
                        </div>
                    </div>

                    <!-- Nueva sección para mostrar el inicio y el fin del recorrido -->
                    <div class="mt-8">
                        <h2 class="text-xl font-bold text-gray-700 mb-4 text-center">Detalles del Recorrido</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                                <h3 class="text-lg font-bold text-gray-700 mb-2">Inicio del Recorrido</h3>
                                <p class="text-gray-600"><span class="font-semibold">Fecha:</span> ${firstPointDate}</p>
                                <p class="text-gray-600"><span class="font-semibold">Hora:</span> ${firstPointTime}</p>
                                <p class="text-gray-600"><span class="font-semibold">Ubicación:</span> ${firstPointLocation}</p>
                            </div>
                            <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                                <h3 class="text-lg font-bold text-gray-700 mb-2">Fin del Recorrido</h3>
                                <p class="text-gray-600"><span class="font-semibold">Fecha:</span> ${lastPointDate}</p>
                                <p class="text-gray-600"><span class="font-semibold">Hora:</span> ${lastPointTime}</p>
                                <p class="text-gray-600"><span class="font-semibold">Ubicación:</span> ${lastPointLocation}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-8">
                        <h2 class="text-xl font-bold text-gray-700 mb-4 text-center">Resumen por Día</h2>
                        <div class="overflow-x-auto rounded-lg shadow-md border border-gray-200">
                            <table class="summary-table min-w-full divide-y divide-gray-200 bg-white">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                                        <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Dist.</th>
                                        <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Vel. Prom.</th>
                                        <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tiempo Det.</th>
                                        <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Excesos</th>
                                        <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acelerones</th>
                                        <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Frenadas</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200">
                                    ${summaryTableContent}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="visualizations-section">
                    <h2 class="text-xl font-bold text-gray-700 mt-8 mb-4 text-center">Visualizaciones de la Ruta</h2>
                    
                    <div class="flex justify-center mb-4">
                        <button onclick="resetZoom()" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-all">
                            Reiniciar Zoom
                        </button>
                    </div>

                    <div class="chart-container">
                        <canvas id="speedChart"></canvas>
                    </div>

                    <div id="map"></div>
                    
                    <div class="chart-container">
                        <canvas id="distanceChart"></canvas>
                    </div>
                </div>
                
                <h2 class="text-xl font-bold text-gray-700 mt-8 mb-4 text-center">Detalle de Eventos de Riesgo</h2>
                <div class="p-4 bg-gray-100 rounded-lg shadow-inner">
                    ${eventsContent}
                </div>
            `;
            
            // Añade un pequeño retraso para asegurar que el DOM se haya actualizado antes de renderizar los gráficos y el mapa.
            setTimeout(() => {
                if (allLatLngs.length > 0) {
                  renderMap(allLatLngs);
                  renderStopsOnMap(stops);
                }
                
                if (speedData.length > 0 && distanceData.length > 0) {
                  renderCharts(speedData, distanceData);
                }
            }, 0);


        } catch (e) {
            console.error(e);
            errorMessage.innerText = "Hubo un error al procesar los datos. Asegúrate de que el formato sea correcto y que hayas ingresado al menos dos puntos para cada día.";
            errorDiv.classList.remove('hidden');
        }
    }

    function renderMap(latLngs) {
        if (mapInstance) {
            mapInstance.remove();
        }
        
        mapInstance = L.map('map').setView(latLngs[0], 13);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(mapInstance);
        
        const polyline = L.polyline(latLngs, {color: 'blue'}).addTo(mapInstance);
        mapInstance.fitBounds(polyline.getBounds());
        
        L.marker(latLngs[0]).addTo(mapInstance)
            .bindPopup('<b>Inicio</b>').openPopup();
        L.marker(latLngs[latLngs.length - 1]).addTo(mapInstance)
            .bindPopup('<b>Fin</b>').openPopup();
    }
    
    function renderStopsOnMap(stops) {
        if (!mapInstance) return;

        const stopIcon = L.divIcon({
            className: 'stop-icon',
            html: 'P',
            iconSize: [24, 24],
            iconAnchor: [12, 12]
        });

        stops.forEach(stop => {
            const popupContent = `
                <div class="font-bold">Parada</div>
                <div>Fecha: ${stop.date}</div>
                <div>Hora: ${stop.time}</div>
                <div>Lugar: ${stop.location}</div>
                <div>Duración: ${formatStopDuration(stop.duration)}</div>
            `;
            L.marker([stop.lat, stop.lon], {icon: stopIcon}).addTo(mapInstance)
                .bindPopup(popupContent);
        });
    }

    function renderCharts(speedData, distanceData) {
        const speedCtx = document.getElementById('speedChart').getContext('2d');
        const distanceCtx = document.getElementById('distanceChart').getContext('2d');
        
        // Destruye los gráficos existentes para evitar duplicados
        if (window.speedChartInstance) window.speedChartInstance.destroy();
        if (window.distanceChartInstance) window.distanceChartInstance.destroy();

        // Data for speed chart, highlighting points above the speed limit
        const speedDataWithHighlights = speedData.map(point => ({
            ...point,
            pointBackgroundColor: point.y > SPEED_LIMIT ? 'red' : '#1d4ed8',
            pointRadius: point.y > SPEED_LIMIT ? 5 : 0
        }));

        window.speedChartInstance = new Chart(speedCtx, {
            type: 'line',
            data: {
                datasets: [{
                    label: 'Velocidad (km/h)',
                    data: speedDataWithHighlights,
                    borderColor: '#1d4ed8',
                    backgroundColor: 'rgba(29, 78, 216, 0.1)',
                    tension: 0.1,
                    pointHoverRadius: 7,
                    pointHoverBackgroundColor: 'red',
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: 'minute',
                            tooltipFormat: 'dd/MM/yyyy HH:mm:ss'
                        },
                        title: {
                            display: true,
                            text: 'Tiempo'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Velocidad (km/h)'
                        }
                    }
                },
                plugins: {
                    // Configuración para el zoom
                    zoom: {
                        zoom: {
                            wheel: { enabled: true },
                            pinch: { enabled: true },
                            mode: 'xy'
                        },
                        pan: {
                            enabled: true,
                            mode: 'xy'
                        }
                    },
                    // Configuración para la línea de anotación
                    annotation: {
                        annotations: {
                            line1: {
                                type: 'line',
                                yMin: SPEED_LIMIT,
                                yMax: SPEED_LIMIT,
                                borderColor: 'rgb(255, 99, 132)',
                                borderWidth: 2,
                                borderDash: [6, 6],
                                label: {
                                    content: 'Límite de velocidad',
                                    enabled: true,
                                    position: 'start',
                                    backgroundColor: 'rgba(255, 99, 132, 0.8)',
                                    color: 'white'
                                }
                            }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const point = context.raw;
                                return `Velocidad: ${point.y.toFixed(2)} km/h\nFecha: ${point.date}\nHora: ${point.time}\nLugar: ${point.location}`;
                            }
                        }
                    }
                }
            }
        });

        window.distanceChartInstance = new Chart(distanceCtx, {
            type: 'line',
            data: {
                datasets: [{
                    label: 'Distancia Acumulada (km)',
                    data: distanceData,
                    borderColor: '#22c55e',
                    backgroundColor: 'rgba(34, 197, 94, 0.1)',
                    tension: 0.1,
                    pointRadius: 5,
                    pointBackgroundColor: '#22c55e',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: 'minute',
                            tooltipFormat: 'dd/MM/yyyy HH:mm:ss'
                        },
                        title: {
                            display: true,
                            text: 'Tiempo'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Distancia (km)'
                        }
                    }
                },
                plugins: {
                    zoom: {
                        zoom: {
                            wheel: { enabled: true },
                            pinch: { enabled: true },
                            mode: 'xy'
                        },
                        pan: {
                            enabled: true,
                            mode: 'xy'
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const point = context.raw;
                                return `Distancia: ${point.y.toFixed(2)} km\nFecha: ${point.date}\nHora: ${point.time}`;
                            }
                        }
                    }
                }
            }
        });
    }

    // Nueva función para reiniciar el zoom de ambos gráficos
    function resetZoom() {
        if (window.speedChartInstance) {
            window.speedChartInstance.resetZoom();
        }
        if (window.distanceChartInstance) {
            window.distanceChartInstance.resetZoom();
        }
    }

    function exportToCSV() {
        const table = document.querySelector('.summary-table');
        if (!table) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = `<div id="error" class="mt-4 text-center text-red-500"><p id="error-message">No hay datos para exportar. Por favor, realiza un análisis primero.</p></div>`;
            return;
        }

        let csv = [];
        const rows = table.querySelectorAll('tr');

        for (const row of rows) {
            const cols = row.querySelectorAll('th, td');
            const rowData = [];
            for (const col of cols) {
                rowData.push(col.innerText);
            }
            csv.push(rowData.join(';'));
        }

        const csvString = csv.join('\n');
        const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.setAttribute('download', 'analisis_ruta_resumen.csv');
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
    
    function exportToPDF() {
        const { jsPDF } = window.jspdf;
        const results = document.getElementById('results');
        if (!results.querySelector('.summary-table')) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = `<div id="error" class="mt-4 text-center text-red-500"><p id="error-message">No hay datos para exportar. Por favor, realiza un análisis primero.</p></div>`;
            return;
        }

        const loader = document.createElement('div');
        loader.innerText = 'Generando PDF...';
        loader.className = 'fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center text-xl font-bold z-50';
        document.body.appendChild(loader);

        html2canvas(results, { scale: 2 }).then(canvas => {
            const imgData = canvas.toDataURL('image/png');
            const pdf = new jsPDF('p', 'mm', 'a4');
            const imgProps = pdf.getImageProperties(imgData);
            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
            
            pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
            pdf.save('analisis_ruta.pdf');
            document.body.removeChild(loader);
        });
    }
</script>

</body>
</html>
